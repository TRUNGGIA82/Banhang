<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qu·∫£n L√Ω Gi√° H√†ng</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { font-family: Arial; margin:0; background:#f2f2f2; }
.header { background:#2f80ed; color:white; padding:15px; text-align:center; font-weight:bold; }
.container { padding:15px; margin-bottom:90px; }

input, select, button, textarea {
width:100%; padding:10px; margin:5px 0;
border-radius:8px; border:1px solid #ccc;
font-size:16px;
}

button { background:#2f80ed; color:white; border:none; }

.card {
background:white; padding:12px; border-radius:10px;
margin-bottom:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

.price { font-size:24px; color:#27ae60; font-weight:bold; }

.nav {
position:fixed; bottom:0; width:100%;
display:flex; background:white; border-top:1px solid #ccc;
}

.nav button { flex:1; background:white; color:#333; }

.hidden { display:none; }
textarea { height:120px; }
#reader { margin-top:10px; }
</style>
</head>
<body>

<div class="header">Qu·∫£n L√Ω Gi√° H√†ng</div>

<!-- TRA C·ª®U -->
<div id="view-search" class="container">
<input type="text" id="searchInput" placeholder="T√¨m t√™n / m√£ / barcode">
<button onclick="startScanner()">üì∑ Qu√©t Barcode</button>
<div id="reader" class="hidden"></div>
<div id="result"></div>
</div>

<!-- DANH S√ÅCH -->
<div id="view-products" class="container hidden">
<h3>Danh s√°ch s·∫£n ph·∫©m</h3>
<div id="productList"></div>
</div>

<!-- IMPORT -->
<div id="view-import" class="container hidden">
<h3>Import Copy - D√°n</h3>
<p>ƒê·ªãnh d·∫°ng: ma,ten,barcode,gia_nhap,gia_ban,ton</p>
<textarea id="importData"></textarea>
<button onclick="importManual()">Import th·ªß c√¥ng</button>

<hr>

<h3>Import File KiotViet (.xlsx)</h3>
<input type="file" id="fileInput" accept=".xlsx,.xls">
<button onclick="handleFile()">Import t·ª´ KiotViet</button>
</div>

<!-- NH·∫¨P H√ÄNG -->
<div id="view-nhap" class="container hidden">
<h3>Nh·∫≠p h√†ng</h3>
<select id="nhapProduct"></select>
<input type="number" id="nhapSoLuong" placeholder="S·ªë l∆∞·ª£ng nh·∫≠p">
<button onclick="nhapHang()">C·∫≠p nh·∫≠t t·ªìn kho</button>
</div>

<div class="nav">
<button onclick="showView('search')">Tra c·ª©u</button>
<button onclick="showView('products')">S·∫£n ph·∫©m</button>
<button onclick="showView('import')">Import</button>
<button onclick="showView('nhap')">Nh·∫≠p</button>
</div>

<script>

let products = JSON.parse(localStorage.getItem("products")) || [];

function saveData(){
localStorage.setItem("products", JSON.stringify(products));
}

function showView(view){
document.querySelectorAll(".container").forEach(v=>v.classList.add("hidden"));
document.getElementById("view-"+view).classList.remove("hidden");
renderProducts();
renderSelect();
}

/* ===== TRA C·ª®U ===== */

document.getElementById("searchInput").addEventListener("input", function(){
searchProduct(this.value);
});

function searchProduct(keyword){
const key = keyword.toLowerCase();
const result = document.getElementById("result");
result.innerHTML="";

products
.filter(p =>
p.ma.toLowerCase().includes(key) ||
p.ten.toLowerCase().includes(key) ||
(p.barcode && p.barcode.includes(key))
)
.forEach(p=>{
result.innerHTML+=`
<div class="card">
<b>${p.ten}</b><br>
M√£: ${p.ma}<br>

<div class="price">${p.gia_ban.toLocaleString()} ƒë</div>

<div style="color:#2980b9;font-weight:bold">
Gi√° s·ªâ: ${(p.gia_si || p.gia_ban).toLocaleString()} ƒë
</div>

Gi√° nh·∫≠p: ${p.gia_nhap.toLocaleString()} ƒë<br>
T·ªìn kho: ${p.ton}
</div>`;

});
}

/* ===== DANH S√ÅCH ===== */

function renderProducts(){
const list=document.getElementById("productList");
list.innerHTML="";
products.forEach(p=>{
list.innerHTML+=`
<div class="card">
<b>${p.ten} (${p.ma})</b>
<div class="price">${p.gia_ban.toLocaleString()} ƒë</div>
Gi√° nh·∫≠p: ${p.gia_nhap.toLocaleString()} ƒë<br>
T·ªìn: ${p.ton}
</div>`;
});
}

function renderSelect(){
const select=document.getElementById("nhapProduct");
select.innerHTML="";
products.forEach((p,i)=>{
select.innerHTML+=`<option value="${i}">${p.ten}</option>`;
});
}

/* ===== IMPORT TH·ª¶ C√îNG ===== */

function importManual(){
const data=document.getElementById("importData").value.trim();
if(!data) return;
const lines=data.split("\n");

lines.forEach(line=>{
let [ma,ten,barcode,gia_nhap,gia_ban,ton]=line.split(",");
if(!ma) return;

let existing=products.find(p=>p.ma==ma);

if(existing){
existing.ten=ten;
existing.barcode=barcode;
existing.gia_nhap=Number(gia_nhap);
existing.gia_ban=Number(gia_ban);
existing.ton=Number(ton);
}else{
products.push({
ma,ten,barcode,
gia_nhap:Number(gia_nhap),
gia_ban:Number(gia_ban),
ton:Number(ton)
});
}
});

saveData();
alert("Import th·ªß c√¥ng th√†nh c√¥ng!");
}

/* ===== IMPORT KIOTVIET ===== */

function handleFile(){
const file=document.getElementById('fileInput').files[0];
if(!file){ alert("Ch·ªçn file tr∆∞·ªõc!"); return; }

const reader=new FileReader();

reader.onload=function(e){
const data=new Uint8Array(e.target.result);
const workbook=XLSX.read(data,{type:'array'});
const sheet=workbook.Sheets[workbook.SheetNames[0]];
const json=XLSX.utils.sheet_to_json(sheet);
importFromKiotViet(json);
};

reader.readAsArrayBuffer(file);
}

function importFromKiotViet(data){

data.forEach(item=>{

let ma=item["M√£ h√†ng"]||item["M√£ s·∫£n ph·∫©m"];
let ten=item["T√™n h√†ng"]||item["T√™n s·∫£n ph·∫©m"];
let gia_nhap=Number(item["Gi√° v·ªën"]||0);
let gia_ban=Number(item["Gi√° b√°n"]||0);
let gia_si=Number(item["Gi√° s·ªâ"]||item["Gi√° b√°n"]||0);
let ton=Number(item["T·ªìn kho"]||0);
let barcode=item["M√£ v·∫°ch"]||"";

if(!ma) return;

let existing=products.find(p=>p.ma==ma);

if(existing){
existing.ten=ten;
existing.gia_nhap=gia_nhap;
existing.gia_ban=gia_ban;
existing.gia_si=gia_si || existing.gia_si || gia_ban;
existing.ton=ton;
existing.barcode=barcode;
}else{
products.push({
ma,
ten,
gia_nhap,
gia_ban,
gia_si,
ton,
barcode
});
}

});

saveData();
alert("Import t·ª´ KiotViet th√†nh c√¥ng!");
}

/* ===== QU√âT BARCODE CAMERA SAU ===== */

let html5QrCode;

function startScanner(){
document.getElementById("reader").classList.remove("hidden");
html5QrCode=new Html5Qrcode("reader");

html5QrCode.start(
{ facingMode: "environment" },   // LU√îN CAMERA SAU
{ fps:10, qrbox:250 },
(decodedText)=>{
document.getElementById("searchInput").value=decodedText;
searchProduct(decodedText);
stopScanner();
}
);
}

function stopScanner(){
if(html5QrCode){
html5QrCode.stop().then(()=>{
document.getElementById("reader").classList.add("hidden");
});
}
}

renderProducts();
renderSelect();

</script>

</body>
</html>
