<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qu·∫£n L√Ω Gi√° H√†ng</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>

:root{
--primary:#1976d2;
--bg:#f5f7fa;
--card:#ffffff;
--text:#1f2937;
--muted:#6b7280;
--border:#e5e7eb;
}

body{
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
margin:0;
background:var(--bg);
color:var(--text);
}

/* HEADER */
.header{
background:var(--primary);
color:white;
padding:14px;
text-align:center;
font-weight:600;
font-size:17px;
box-shadow:0 2px 4px rgba(0,0,0,0.1);
}

/* CONTENT */
.container{
padding:16px;
margin-bottom:90px;
}

/* INPUT */
input, select, textarea{
width:100%;
padding:12px;
border-radius:8px;
border:1px solid var(--border);
font-size:15px;
margin-bottom:10px;
}

/* BUTTON */
button{
width:100%;
padding:12px;
border-radius:8px;
border:none;
background:var(--primary);
color:white;
font-weight:500;
cursor:pointer;
}

/* CARD */
.card{
background:var(--card);
padding:16px;
border-radius:12px;
margin-bottom:14px;
border:1px solid var(--border);
box-shadow:0 2px 8px rgba(0,0,0,0.04);
}

.price{
font-size:22px;
font-weight:700;
color:var(--primary);
margin:6px 0;
}

.price-si{
font-size:15px;
color:#2563eb;
font-weight:600;
margin-bottom:6px;
}

.meta{
font-size:14px;
color:var(--muted);
margin-top:3px;
}

/* BOTTOM NAV */
.nav{
position:fixed;
bottom:0;
width:100%;
display:flex;
background:white;
border-top:1px solid var(--border);
}

.nav-item{
flex:1;
text-align:center;
padding:8px 0;
font-size:12px;
color:var(--muted);
cursor:pointer;
}

.nav-item svg{
width:20px;
height:20px;
display:block;
margin:0 auto 4px auto;
}

.nav-item.active{
color:var(--primary);
font-weight:600;
}

.hidden{ display:none; }

#reader{ margin-top:10px; }
/* ===== CAMERA STYLE - CHUY√äN NGHI·ªÜP H∆†N ===== */

#reader{
    margin-top:15px;
    background:#000;
    padding:12px;
    border-radius:16px;
    box-shadow:0 8px 20px rgba(0,0,0,0.35);
}

#reader video{
    width:100%;
    border-radius:12px;
}

/* Khung qu√©t r√µ n√©t h∆°n */
#reader::after{
    content:"ƒê∆∞a m√£ v·∫°ch v√†o khung";
    position:absolute;
    bottom:18px;
    left:50%;
    transform:translateX(-50%);
    color:#fff;
    font-size:14px;
    background:rgba(0,0,0,0.6);
    padding:6px 12px;
    border-radius:20px;
}

/* Vi·ªÅn khung qu√©t */
#reader canvas{
    border-radius:12px;
}

</style>
</head>
<body>

<div class="header">Qu·∫£n L√Ω Gi√° H√†ng</div>

<!-- TRA C·ª®U -->
<div id="view-search" class="container">
<input type="text" id="searchInput" placeholder="T√¨m t√™n / m√£ / barcode">
<button onclick="startScanner()">üì∑ Qu√©t Barcode</button>
<div id="reader" class="hidden"></div>
<div id="result"></div>
</div>

<!-- DANH S√ÅCH -->
<div id="view-products" class="container hidden">
<h3>Danh s√°ch s·∫£n ph·∫©m</h3>
<div id="productList"></div>
</div>

<!-- IMPORT -->
<div id="view-import" class="container hidden">
<h3>Import Copy - D√°n</h3>
<textarea id="importData" placeholder="ma,ten,barcode,gia_nhap,gia_ban,gia_si,ton"></textarea>
<button onclick="importManual()">Import th·ªß c√¥ng</button>

<hr>

<h3>Import File KiotViet (.xlsx)</h3>
<input type="file" id="fileInput" accept=".xlsx,.xls">
<button onclick="handleFile()">Import t·ª´ KiotViet</button>
</div>

<!-- NH·∫¨P -->
<div id="view-nhap" class="container hidden">
<h3>Nh·∫≠p h√†ng</h3>
<select id="nhapProduct"></select>
<input type="number" id="nhapSoLuong" placeholder="S·ªë l∆∞·ª£ng nh·∫≠p">
<button onclick="nhapHang()">C·∫≠p nh·∫≠t t·ªìn kho</button>
</div>

<!-- BOTTOM NAV -->
<div class="nav">
<div class="nav-item active" onclick="showView('search',this)">
<i data-lucide="search"></i>
Tra c·ª©u
</div>
<div class="nav-item" onclick="showView('products',this)">
<i data-lucide="box"></i>
S·∫£n ph·∫©m
</div>
<div class="nav-item" onclick="showView('import',this)">
<i data-lucide="upload"></i>
Import
</div>
<div class="nav-item" onclick="showView('nhap',this)">
<i data-lucide="plus-circle"></i>
Nh·∫≠p
</div>
</div>

<script>

lucide.createIcons();

let products = JSON.parse(localStorage.getItem("products")) || [];

function saveData(){
localStorage.setItem("products", JSON.stringify(products));
}

function showView(view,el){
document.querySelectorAll(".container").forEach(v=>v.classList.add("hidden"));
document.getElementById("view-"+view).classList.remove("hidden");

document.querySelectorAll(".nav-item").forEach(i=>i.classList.remove("active"));
if(el) el.classList.add("active");

renderProducts();
renderSelect();
}

/* SEARCH */
document.getElementById("searchInput").addEventListener("input",function(){
searchProduct(this.value);
});

function searchProduct(keyword){
const key=keyword.toLowerCase();
const result=document.getElementById("result");
result.innerHTML="";

products
.filter(p=>p.ma.toLowerCase().includes(key)||
p.ten.toLowerCase().includes(key)||
(p.barcode&&p.barcode.includes(key)))
.forEach(p=>{
result.innerHTML+=`
<div class="card">
<b>${p.ten}</b>
<div class="meta">M√£: ${p.ma}</div>

<div class="price">${p.gia_ban.toLocaleString()} ƒë</div>
<div class="price-si">Gi√° s·ªâ: ${(p.gia_si||p.gia_ban).toLocaleString()} ƒë</div>

<div class="meta">Gi√° nh·∫≠p: ${p.gia_nhap.toLocaleString()} ƒë</div>
<div class="meta">T·ªìn kho: ${p.ton}</div>
</div>`;
});
}

/* LIST */
function renderProducts(){
const list=document.getElementById("productList");
list.innerHTML="";
products.forEach(p=>{
list.innerHTML+=`
<div class="card">
<b>${p.ten} (${p.ma})</b>
<div class="price">${p.gia_ban.toLocaleString()} ƒë</div>
<div class="price-si">Gi√° s·ªâ: ${(p.gia_si||p.gia_ban).toLocaleString()} ƒë</div>
<div class="meta">Gi√° nh·∫≠p: ${p.gia_nhap.toLocaleString()} ƒë</div>
<div class="meta">T·ªìn: ${p.ton}</div>
</div>`;
});
}

function renderSelect(){
const select=document.getElementById("nhapProduct");
select.innerHTML="";
products.forEach((p,i)=>{
select.innerHTML+=`<option value="${i}">${p.ten}</option>`;
});
}

/* IMPORT MANUAL */
function importManual(){
const data=document.getElementById("importData").value.trim();
if(!data) return;
data.split("\n").forEach(line=>{
let [ma,ten,barcode,gia_nhap,gia_ban,gia_si,ton]=line.split(",");
if(!ma) return;
products.push({
ma,ten,barcode,
gia_nhap:Number(gia_nhap),
gia_ban:Number(gia_ban),
gia_si:Number(gia_si)||Number(gia_ban),
ton:Number(ton)
});
});
saveData();
alert("Import th·ªß c√¥ng th√†nh c√¥ng!");
}

/* IMPORT KIOTVIET */
function handleFile(){
const file=document.getElementById('fileInput').files[0];
if(!file){ alert("Ch·ªçn file tr∆∞·ªõc!"); return; }
const reader=new FileReader();
reader.onload=function(e){
const data=new Uint8Array(e.target.result);
const workbook=XLSX.read(data,{type:'array'});
const sheet=workbook.Sheets[workbook.SheetNames[0]];
const json=XLSX.utils.sheet_to_json(sheet);
json.forEach(item=>{
let ma=item["M√£ h√†ng"]||item["M√£ s·∫£n ph·∫©m"];
if(!ma) return;
products.push({
ma,
ten:item["T√™n h√†ng"]||"",
barcode:item["M√£ v·∫°ch"]||"",
gia_nhap:Number(item["Gi√° v·ªën"]||0),
gia_ban:Number(item["Gi√° b√°n"]||0),
gia_si:Number(item["Gi√° s·ªâ"]||item["Gi√° b√°n"]||0),
ton:Number(item["T·ªìn kho"]||0)
});
});
saveData();
alert("Import KiotViet th√†nh c√¥ng!");
};
reader.readAsArrayBuffer(file);
}

/* NH·∫¨P */
function nhapHang(){
const index=document.getElementById("nhapProduct").value;
const sl=Number(document.getElementById("nhapSoLuong").value);
if(!sl) return;
products[index].ton+=sl;
saveData();
alert("ƒê√£ c·∫≠p nh·∫≠t t·ªìn kho!");
}

/* BARCODE */
let html5QrCode;
function startScanner(){

document.getElementById("reader").classList.remove("hidden");

html5QrCode = new Html5Qrcode("reader");

html5QrCode.start(
{ facingMode: "environment" },
{
fps: 10,
qrbox: { width: 250, height: 250 }
},
(decodedText) => {
document.getElementById("searchInput").value = decodedText;
searchProduct(decodedText);
stopScanner();
}
);

}


renderProducts();
renderSelect();

</script>

</body>
</html>
